下面我一次性把 /admin/risk 的页面 + API（Neon 模板）+ validate-risk gate 给你整包（可直接复制落地），并且完全遵守你们已锁死的纪律：
    •    Admin 只读（除“复核 resolve”）
    •    受 middleware.ts 的 ADMIN_KEY 保护（/admin 与 /api/admin）
    •    不在前端做风控计算（全部由服务端 repo 返回）
    •    四态 UI（Loading/Empty/Error/Degraded）
    •    pnpm validate 可锁死关键点

前置：你已经有

    •    src/server/risk/riskModel.ts
    •    src/server/repo/antiCheatRepo.ts（antiCheatRepoPg）
    •    PG 表 anti_cheat_* 已写入 pg_migrate.sql

⸻

1) Admin Risk APIs（/api/admin/risk/*）

1.1 app/api/admin/risk/summary/route.ts

import { NextResponse } from "next/server";
import { z } from "zod";
import { antiCheatRepoPg } from "@/src/server/repo/antiCheatRepo";

const q = z.object({
  day: z.string().optional(), // YYYY-MM-DD, default today
});

function dayIdUtc8(ts = Date.now()) {
  const d = new Date(ts + 8 * 3600 * 1000);
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(d.getUTCDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

export async function GET(req: Request) {
  try {
    const url = new URL(req.url);
    const parsed = q.safeParse({ day: url.searchParams.get("day") || undefined });
    if (!parsed.success) return NextResponse.json({ code:"BAD_REQUEST", message:"invalid query" }, { status: 400 });

    const day = parsed.data.day || dayIdUtc8();
    const repo = antiCheatRepoPg();

    const rows = await repo.summary(day);
    const counts: Record<string, number> = { allow: 0, shadow: 0, review: 0, deny: 0 };
    for (const r of rows as any[]) counts[String(r.decision)] = Number(r.n);

    // open reviews
    const open = await repo.listOpenReviews(50);

    return NextResponse.json({
      day,
      counts,
      openReviews: open,
    });
  } catch (e: any) {
    return NextResponse.json({ code:"SERVER_ERROR", message:e?.message || "error" }, { status: 500 });
  }
}

1.2 app/api/admin/risk/runs/route.ts

import { NextResponse } from "next/server";
import { z } from "zod";
import { antiCheatRepoPg } from "@/src/server/repo/antiCheatRepo";

const q = z.object({
  day: z.string(),
  min: z.coerce.number().int().min(0).max(100).optional(),
});

export async function GET(req: Request) {
  const url = new URL(req.url);
  const parsed = q.safeParse({
    day: url.searchParams.get("day") || "",
    min: url.searchParams.get("min") || undefined,
  });
  if (!parsed.success) return NextResponse.json({ code:"BAD_REQUEST", message:"day required" }, { status: 400 });

  try {
    const repo = antiCheatRepoPg();
    const rows = await repo.listRuns(parsed.data.day, parsed.data.min ?? 40);
    return NextResponse.json({ day: parsed.data.day, min: parsed.data.min ?? 40, runs: rows });
  } catch (e:any) {
    return NextResponse.json({ code:"SERVER_ERROR", message:e?.message || "error" }, { status: 500 });
  }
}

1.3 app/api/admin/risk/address/route.ts

import { NextResponse } from "next/server";
import { z } from "zod";
import { antiCheatRepoPg } from "@/src/server/repo/antiCheatRepo";

const q = z.object({ address: z.string().min(3) });

export async function GET(req: Request) {
  const url = new URL(req.url);
  const parsed = q.safeParse({ address: url.searchParams.get("address") || "" });
  if (!parsed.success) return NextResponse.json({ code:"BAD_REQUEST", message:"address required" }, { status: 400 });

  try {
    const repo = antiCheatRepoPg();
    const row = await repo.getAddress(parsed.data.address);
    return NextResponse.json({ address: parsed.data.address, profile: row });
  } catch (e:any) {
    return NextResponse.json({ code:"SERVER_ERROR", message:e?.message || "error" }, { status: 500 });
  }
}

1.4 app/api/admin/risk/reviews/open/route.ts

import { NextResponse } from "next/server";
import { antiCheatRepoPg } from "@/src/server/repo/antiCheatRepo";

export async function GET() {
  try {
    const repo = antiCheatRepoPg();
    const rows = await repo.listOpenReviews(200);
    return NextResponse.json({ reviews: rows });
  } catch (e:any) {
    return NextResponse.json({ code:"SERVER_ERROR", message:e?.message || "error" }, { status: 500 });
  }
}

1.5 app/api/admin/risk/reviews/resolve/route.ts

import { NextResponse } from "next/server";
import { z } from "zod";
import { antiCheatRepoPg } from "@/src/server/repo/antiCheatRepo";

const bodySchema = z.object({
  id: z.number().int().positive(),
  resolution: z.enum(["legit", "cheat", "unknown"]),
  reviewer: z.string().min(1),
  note: z.string().optional(),
});

export async function POST(req: Request) {
  const body = await req.json();
  const parsed = bodySchema.safeParse(body);
  if (!parsed.success) return NextResponse.json({ code:"BAD_REQUEST", message:"invalid body" }, { status: 400 });

  try {
    const repo = antiCheatRepoPg();
    await repo.resolveReview(parsed.data.id, parsed.data.resolution, parsed.data.reviewer, parsed.data.note);
    return NextResponse.json({ ok: true });
  } catch (e:any) {
    return NextResponse.json({ code:"SERVER_ERROR", message:e?.message || "error" }, { status: 500 });
  }
}


⸻

2) Admin 页面（Neon Tech + 四态）

2.1 app/admin/risk/page.tsx（总览 + open reviews）

"use client";

import { useEffect, useState } from "react";
import NeonCard from "@/src/components/ui/NeonCard";
import NeonIcon from "@/src/components/ui/NeonIcon";
import NeonButton from "@/src/components/ui/NeonButton";
import { RefreshCw, AlertTriangle, Shield, Eye, Ban, CheckCircle2 } from "lucide-react";

type UIState = "LOADING" | "EMPTY" | "ERROR" | "DEGRADED" | "READY";
type Summary = {
  day: string;
  counts: { allow: number; shadow: number; review: number; deny: number };
  openReviews: any[];
};

export default function AdminRiskPage() {
  const [ui, setUi] = useState<UIState>("LOADING");
  const [data, setData] = useState<Summary | null>(null);
  const [err, setErr] = useState("");

  async function load() {
    setUi("LOADING");
    setErr("");
    try {
      const res = await fetch("/api/admin/risk/summary", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = (await res.json()) as Summary;
      setData(json);
      const empty = (json.openReviews?.length ?? 0) === 0 &&
        (json.counts?.shadow ?? 0) === 0 &&
        (json.counts?.review ?? 0) === 0 &&
        (json.counts?.deny ?? 0) === 0;
      setUi(empty ? "EMPTY" : "READY");
    } catch (e:any) {
      setErr(e?.message || "error");
      setUi("ERROR");
    }
  }

  useEffect(() => { load(); }, []);

  const c = data?.counts || { allow:0, shadow:0, review:0, deny:0 };

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-white text-2xl font-black">Risk Control</div>
          <div className="text-white/60 text-sm">Anti-cheat runs, decisions, and review queue</div>
        </div>
        <div className="flex gap-2">
          <NeonButton variant="secondary" onClick={load} className="gap-2">
            <NeonIcon icon={RefreshCw} color="cyan" /> Refresh
          </NeonButton>
          <NeonButton variant="secondary" onClick={() => (window.location.href = "/admin/risk/runs")} className="gap-2">
            <NeonIcon icon={Eye} color="cyan" /> View Runs
          </NeonButton>
        </div>
      </div>

      {ui === "LOADING" && (
        <NeonCard title="Loading" subtitle="Fetching risk summary...">
          <div className="text-white/60">Loading...</div>
        </NeonCard>
      )}

      {ui === "ERROR" && (
        <NeonCard title="Error" subtitle="Failed to load">
          <div className="text-red-300 font-mono text-sm">{err}</div>
          <div className="mt-3"><NeonButton variant="primary" onClick={load}>Retry</NeonButton></div>
        </NeonCard>
      )}

      {ui === "EMPTY" && (
        <NeonCard title="All Clear" subtitle="No suspicious activity detected today">
          <div className="text-white/60 text-sm">Shadow/Review/Deny counts are zero and review queue is empty.</div>
        </NeonCard>
      )}

      {ui === "READY" && data && (
        <>
          <NeonCard title="Decision Summary" subtitle={`Day: ${data.day}`}>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <NeonCard title="Allow" subtitle="">
                <div className="flex items-center justify-between">
                  <div className="font-mono text-3xl font-black text-white">{c.allow}</div>
                  <NeonIcon icon={CheckCircle2} color="cyan" />
                </div>
              </NeonCard>
              <NeonCard title="Shadow" subtitle="No leaderboard + no rewards">
                <div className="flex items-center justify-between">
                  <div className="font-mono text-3xl font-black text-white">{c.shadow}</div>
                  <NeonIcon icon={Shield} color="purple" />
                </div>
              </NeonCard>
              <NeonCard title="Review" subtitle="Delayed rewards">
                <div className="flex items-center justify-between">
                  <div className="font-mono text-3xl font-black text-white">{c.review}</div>
                  <NeonIcon icon={AlertTriangle} color="yellow" />
                </div>
              </NeonCard>
              <NeonCard title="Deny" subtitle="No leaderboard + no rewards">
                <div className="flex items-center justify-between">
                  <div className="font-mono text-3xl font-black text-white">{c.deny}</div>
                  <NeonIcon icon={Ban} color="yellow" />
                </div>
              </NeonCard>
            </div>
          </NeonCard>

          <NeonCard title="Open Reviews" subtitle={`${data.openReviews?.length ?? 0} open`}>
            {(data.openReviews?.length ?? 0) === 0 ? (
              <div className="text-white/60 text-sm">No open reviews.</div>
            ) : (
              <div className="space-y-2">
                {data.openReviews.map((r: any) => (
                  <div key={r.id} className="border border-white/10 rounded-xl p-3 flex items-center justify-between">
                    <div>
                      <div className="text-white font-mono text-sm">#{r.id} · {r.run_id}</div>
                      <div className="text-white/60 text-xs font-mono">{r.address}</div>
                    </div>
                    <NeonButton variant="secondary" onClick={() => (window.location.href = `/admin/risk/runs?day=${data.day}&min=70`)}>Review</NeonButton>
                  </div>
                ))}
              </div>
            )}
          </NeonCard>
        </>
      )}
    </div>
  );
}

2.2 app/admin/risk/runs/page.tsx（可疑 runs 列表）

"use client";

import { useEffect, useMemo, useState } from "react";
import NeonCard from "@/src/components/ui/NeonCard";
import NeonIcon from "@/src/components/ui/NeonIcon";
import NeonButton from "@/src/components/ui/NeonButton";
import { RefreshCw, Search, ArrowLeft } from "lucide-react";

type UIState = "LOADING" | "EMPTY" | "ERROR" | "READY";
type RunRow = any;

function dayIdUtc8(ts = Date.now()) {
  const d = new Date(ts + 8 * 3600 * 1000);
  const yyyy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(d.getUTCDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

export default function AdminRiskRunsPage() {
  const [ui, setUi] = useState<UIState>("LOADING");
  const [err, setErr] = useState("");
  const [runs, setRuns] = useState<RunRow[]>([]);
  const [day, setDay] = useState(dayIdUtc8());
  const [min, setMin] = useState(40);

  async function load() {
    setUi("LOADING");
    setErr("");
    try {
      const res = await fetch(`/api/admin/risk/runs?day=${encodeURIComponent(day)}&min=${min}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const list = json.runs || [];
      setRuns(list);
      setUi(list.length ? "READY" : "EMPTY");
    } catch (e:any) {
      setErr(e?.message || "error");
      setUi("ERROR");
    }
  }

  useEffect(() => { load(); }, []);

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-white text-2xl font-black">Suspicious Runs</div>
          <div className="text-white/60 text-sm">Server-side risk logs (read-only)</div>
        </div>
        <div className="flex gap-2">
          <NeonButton variant="secondary" onClick={() => (window.location.href = "/admin/risk")} className="gap-2">
            <NeonIcon icon={ArrowLeft} color="cyan" /> Back
          </NeonButton>
          <NeonButton variant="secondary" onClick={load} className="gap-2">
            <NeonIcon icon={RefreshCw} color="cyan" /> Refresh
          </NeonButton>
        </div>
      </div>

      <NeonCard title="Filters" subtitle="Day + min risk score">
        <div className="flex flex-wrap items-end gap-3">
          <div>
            <div className="text-white/60 text-xs mb-1">Day</div>
            <input className="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white font-mono text-sm"
              value={day} onChange={(e) => setDay(e.target.value)} />
          </div>
          <div>
            <div className="text-white/60 text-xs mb-1">Min Score</div>
            <input type="number" className="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white font-mono text-sm w-28"
              value={min} onChange={(e) => setMin(Number(e.target.value))} />
          </div>
          <NeonButton variant="primary" onClick={load} className="gap-2">
            <NeonIcon icon={Search} color="cyan" /> Apply
          </NeonButton>
        </div>
      </NeonCard>

      {ui === "LOADING" && <NeonCard title="Loading" subtitle="Fetching runs..."><div className="text-white/60">Loading...</div></NeonCard>}
      {ui === "ERROR" && <NeonCard title="Error" subtitle="Failed to load"><div className="text-red-300 font-mono">{err}</div></NeonCard>}
      {ui === "EMPTY" && <NeonCard title="Empty" subtitle="No runs match filters"><div className="text-white/60">Try lowering min score.</div></NeonCard>}

      {ui === "READY" && (
        <NeonCard title="Runs" subtitle={`${runs.length} rows`}>
          <div className="space-y-2">
            {runs.map((r: any) => (
              <div key={r.run_id} className="border border-white/10 rounded-xl p-3 flex items-start justify-between gap-3">
                <div>
                  <div className="text-white font-mono text-xs">{r.run_id}</div>
                  <div className="text-white/60 text-xs font-mono">{r.address}</div>
                  <div className="text-white/50 text-[10px] font-mono">
                    mode={r.mode} · raw={r.raw_score} · eff={r.effective_time_sec}s · rank={r.rank_score}
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-white font-mono font-black">{r.risk_score}</div>
                  <div className="text-white/60 text-xs font-mono">{r.decision}</div>
                  <NeonButton variant="secondary" onClick={() => window.open(`/admin/risk/address?address=${encodeURIComponent(r.address)}`, "_self")}>
                    Address
                  </NeonButton>
                </div>
              </div>
            ))}
          </div>
        </NeonCard>
      )}
    </div>
  );
}

2.3 app/admin/risk/address/page.tsx（地址画像）

"use client";

import { useEffect, useState } from "react";
import NeonCard from "@/src/components/ui/NeonCard";
import NeonIcon from "@/src/components/ui/NeonIcon";
import NeonButton from "@/src/components/ui/NeonButton";
import { ArrowLeft, RefreshCw } from "lucide-react";

type UIState = "LOADING" | "ERROR" | "EMPTY" | "READY";

export default function AdminRiskAddressPage() {
  const url = new URL(typeof window !== "undefined" ? window.location.href : "http://x");
  const address = url.searchParams.get("address") || "";

  const [ui, setUi] = useState<UIState>("LOADING");
  const [err, setErr] = useState("");
  const [profile, setProfile] = useState<any>(null);

  async function load() {
    setUi("LOADING");
    setErr("");
    try {
      const res = await fetch(`/api/admin/risk/address?address=${encodeURIComponent(address)}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      setProfile(json.profile);
      setUi(json.profile ? "READY" : "EMPTY");
    } catch (e:any) {
      setErr(e?.message || "error");
      setUi("ERROR");
    }
  }

  useEffect(() => { load(); }, []);

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-white text-2xl font-black">Address Risk</div>
          <div className="text-white/60 text-sm font-mono">{address}</div>
        </div>
        <div className="flex gap-2">
          <NeonButton variant="secondary" onClick={() => (window.location.href = "/admin/risk")} className="gap-2">
            <NeonIcon icon={ArrowLeft} color="cyan" /> Back
          </NeonButton>
          <NeonButton variant="secondary" onClick={load} className="gap-2">
            <NeonIcon icon={RefreshCw} color="cyan" /> Refresh
          </NeonButton>
        </div>
      </div>

      {ui === "LOADING" && <NeonCard title="Loading" subtitle="Fetching address profile..."><div className="text-white/60">Loading...</div></NeonCard>}
      {ui === "ERROR" && <NeonCard title="Error" subtitle="Failed to load"><div className="text-red-300 font-mono">{err}</div></NeonCard>}
      {ui === "EMPTY" && <NeonCard title="Empty" subtitle="No profile found"><div className="text-white/60">No runs recorded yet.</div></NeonCard>}

      {ui === "READY" && profile && (
        <NeonCard title="Profile" subtitle="Aggregated stats">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div className="border border-white/10 rounded-xl p-3">
              <div className="text-white/60 text-xs">Runs</div>
              <div className="text-white font-mono">
                total={profile.runs_total} · endless={profile.runs_endless} · story={profile.runs_story}
              </div>
            </div>
            <div className="border border-white/10 rounded-xl p-3">
              <div className="text-white/60 text-xs">Risk</div>
              <div className="text-white font-mono">
                avg={profile.risk_avg} · max={profile.risk_max}
              </div>
            </div>
            <div className="border border-white/10 rounded-xl p-3 md:col-span-2">
              <div className="text-white/60 text-xs">Decisions</div>
              <div className="text-white font-mono text-sm whitespace-pre-wrap">
                {JSON.stringify(profile.decisions, null, 2)}
              </div>
            </div>
          </div>
        </NeonCard>
      )}
    </div>
  );
}


⸻

3) validate gate：scripts/validate/validate-risk.mjs（一次 ok 输出）

新建 scripts/validate/validate-risk.mjs：

import { exists, read, fail, ok } from "./_util.mjs";

const required = [
  "src/server/risk/riskModel.ts",
  "src/server/repo/antiCheatRepo.ts",
  "src/server/db/pg_migrate.sql",

  "app/api/admin/risk/summary/route.ts",
  "app/api/admin/risk/runs/route.ts",
  "app/api/admin/risk/address/route.ts",
  "app/api/admin/risk/reviews/open/route.ts",
  "app/api/admin/risk/reviews/resolve/route.ts",

  "app/admin/risk/page.tsx",
  "app/admin/risk/runs/page.tsx",
  "app/admin/risk/address/page.tsx",
];

for (const f of required) if (!exists(f)) fail(`validate-risk: missing ${f}`);

const schema = read("src/server/db/pg_migrate.sql");
const mustTables = ["anti_cheat_runs", "anti_cheat_addresses", "anti_cheat_reviews"];
for (const t of mustTables) {
  if (!schema.includes(t)) fail(`validate-risk: pg_migrate.sql must include ${t}`);
}

const repo = read("src/server/repo/antiCheatRepo.ts");
if (!repo.includes("anti_cheat_runs") || !repo.includes("recordRun")) {
  fail("validate-risk: antiCheatRepo must record anti_cheat_runs");
}

const adminPages = [
  "app/admin/risk/page.tsx",
  "app/admin/risk/runs/page.tsx",
  "app/admin/risk/address/page.tsx",
];
for (const p of adminPages) {
  const s = read(p);
  const must = ["NeonCard", "LOADING", "ERROR", "EMPTY"];
  for (const tok of must) if (!s.includes(tok)) fail(`validate-risk: ${p} missing ${tok}`);
  if (s.includes("Math.random") || s.includes("weight")) fail(`validate-risk: ${p} must not do draw logic`);
}

ok("validate-risk passed: anti-cheat tables/repo/apis/admin pages present (Neon + four states).");

接入 scripts/validate/validate-all.mjs：

import "./validate-risk.mjs";

并可在 package.json 加：

"validate:risk": "node scripts/validate/validate-risk.mjs"


⸻

4) 验收步骤（最短）
    1.    pnpm dev
    2.    访问（带 admin key）：

    •    /admin/risk
    •    /admin/risk/runs?day=YYYY-MM-DD&min=40
    •    /admin/risk/address?address=0x...

    3.    pnpm validate → PASS（含 validate-risk）

⸻

